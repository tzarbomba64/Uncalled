<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uncalled - Downloads</title>
  <style>
    body { background: #000; color: #fff; font-family: Arial, sans-serif; padding: 20px; }
    h1, h2, h3 { color: #00aaff; }
    a { color: #00aaff; }
    pre, code { background: #111; padding: 10px; border-radius: 5px; }
    .download-btn {
      display: inline-flex;
      align-items: center;
      background-color: #00aaff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px 10px 0 0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      text-decoration: none;
    }
    .download-btn img {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .error {
      margin-top: 20px;
      padding: 10px;
      background: #330000;
      border: 1px solid #ff0000;
      border-radius: 5px;
      color: #ff5555;
    }
  </style>
</head>
<body>

  <div id="content">Loading README...</div>

  <h2>Downloads</h2>
  <div id="downloads"></div>

  <div id="error" class="error" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script>
    const owner = 'tzarbomba64';
    const repo = 'Uncalled';
    const branch = 'main';
    const readmeUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/README.md`;
    const listApiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/list?ref=${branch}`;
    const winLogoUrl = 'https://i.postimg.cc/2jJkfTC9/download.png'; // your custom windows logo

    function showError(msg) {
      const errorBox = document.getElementById('error');
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
      console.error(msg);
    }

    function loadReadme() {
      fetch(readmeUrl)
        .then(res => res.text())
        .then(md => {
          document.getElementById('content').innerHTML = marked.parse(md);
        })
        .catch(() => showError('Failed to load README.'));
    }

    function listDownloads() {
      fetch(listApiUrl)
        .then(res => res.json())
        .then(files => {
          const downloadsDiv = document.getElementById('downloads');
          const normalFiles = [];
          let baseFile = null;

          files.forEach(file => {
            const cleanName = file.name.toLowerCase();
            if (cleanName === 'base' || cleanName === 'base.zip') {
              baseFile = file;
            } else {
              normalFiles.push(file);
            }
          });

          normalFiles.forEach(file => {
            const btn = createDownloadButton(file.name.replace(/\.[^/.]+$/, ''), file);
            downloadsDiv.appendChild(btn);
          });

          if (baseFile) {
            const baseBtn = createWindowsInstallerButton(baseFile);
            downloadsDiv.appendChild(baseBtn);
          }
        })
        .catch(() => showError('Failed to load downloads.'));
    }

    function createDownloadButton(label, file) {
      const btn = document.createElement('button');
      btn.className = 'download-btn';
      btn.textContent = `Download ${label}.zip`;
      btn.onclick = () => zipAndDownload(file);
      return btn;
    }

    function createWindowsInstallerButton(file) {
      const btn = document.createElement('button');
      btn.className = 'download-btn';
      btn.innerHTML = `<img src="${winLogoUrl}" alt="Windows">Download Windows installer`;
      btn.onclick = () => zipAndDownload(file);
      return btn;
    }

    function zipAndDownload(file) {
      fetch(file.download_url)
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.blob();
        })
        .then(blob => {
          const zip = new JSZip();
          zip.file(file.name, blob);
          return zip.generateAsync({ type: 'blob' });
        })
        .then(zipBlob => {
          const url = URL.createObjectURL(zipBlob);
          const a = document.createElement('a');
          a.href = url;

          const cleanName = file.name.replace(/\.[^/.]+$/, ''); // remove extension
          a.download = `${cleanName}.zip`; // always a .zip

          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 10000);
        })
        .catch(err => {
          console.error('Download failed:', err);
          showError('Download failed.');
        });
    }

    loadReadme();
    listDownloads();
  </script>

</body>
</html>
